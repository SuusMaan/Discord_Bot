# -*- coding: utf-8 -*-
import discord
from discord.ext import commands
import random
import requests
import json
import os
from dotenv import load_dotenv

load_dotenv()  # Загружаем переменные окружения из .env

# --- Вспомогательные функции для создания Embed ---
def create_embed(title=None, description=None, color=discord.Color.blue(), fields=None, footer_text=None, footer_icon_url=None, image_url=None, thumbnail_url=None):
    """Создает embed с возможностью настройки цвета, footer, полей, изображения и thumbnail."""
    embed = discord.Embed(title=title, description=description, color=color)
    if fields:
        for field in fields:
            embed.add_field(**field)
    if footer_text:
        embed.set_footer(text=footer_text, icon_url=footer_icon_url)
    if image_url:
        embed.set_image(url=image_url)
    if thumbnail_url:
        embed.set_thumbnail(url=thumbnail_url)
    return embed

# Ваши списки
roasts = [
    "Эй, {user}, твой код выглядит так, будто его писал пьяный енот.",
    "{user}, ты настолько тупой, что мог бы спорить с камнем и проиграть.",
    "Извини, {user}, но у тебя мозгов, как у креветки.",
    "{user}, если бы глупость была золото, ты был бы миллиардером.",
    "Ты, {user}, как Wi-Fi — у тебя все подключения слабые.",
    "Эй, {user}, ты живое доказательство того, что эволюция может и ошибаться.",
    "Извини, {user}, но даже инструкция по сборке мебели сложнее, чем твои мысли.",
    "{user}, в твоей голове, похоже, только пробки от бутылок.",
    "Слушай, {user}, ты как загадка, над которой никто не хочет думать.",
    "{user}, ты настолько неумный, что даже алгоритмы не могут тебя понять.",
    "Эй, {user}, твое IQ ниже температуры на улице.",
    "{user}, если бы тупость была жанром кино, ты был бы номинирован на Оскар.",
    "{user}, ты как компьютер без процессора — просто тормоз.",
    "Ты знаешь, {user}, я бы хотел видеть мир без тебя.",
    "Эй, {user}, с тобой даже зеркала не хотят разговаривать.",
    "{user}, твоя жизнь — это реалити-шоу, но кого это интересует?",
    "Если бы можно было зарабатывать на пустоте, {user}, ты был бы богат.",
    "Слушай, {user}, даже твой отражение смотрит на тебя с жалостью.",
    "Если бы ты был антивирусом, я бы удалил тебя с компьютера.",
    "Эй, {user}, если б я был твоим GPS, я бы уехал в другой город.",
    "{user}, твой алгоритм мышления — это как зебра без полосок.",
    "Извини, {user}, но твоя логика танцует под музыку, которую никто не слышит.",
    "Эй, {user}, ты - как недоступный Wi-Fi: много шума, но мало пользы.",
    "{user}, ты бы классно смотрелся в роли подставки для книг.",
    "{user}, даже облака обходят тебя стороной, чтобы не затмить.",
    "Эй, {user}, твой кот явно умнее тебя.",
    "Если бы у тебя был мозг, ты бы не боялся его использовать, {user}.",
    "Ты как тостер без функции поджаривания — бесполезен.",
    "{user}, тысихоциноз — единственный, кто не осуждает тебя.",
    "Эй, {user}, у тебя такой же талант, как у рыбы на дереве.",
    "Ты знаешь, {user}, твоя карьера напоминает кометоидный дождь — проходит мимо.",
    "Слушай, {user}, у тебя больше шансов на успех, если ты просто сядешь на диван.",
    "Эй, {user}, если бы тупость была профессией, у тебя был бы диплом.",
    "Ты как библиотека с закрытыми книгами, {user} — безумно пустой.",
    "{user}, даже звезды на небе теряются в твоем сиянии глупости.",
    "Слушай, {user}, скорее всего, даже будильник не сможет тебя разбудить от бездарности.",
    "Ты, {user}, похож на облако — всегда затмеваешь солнце.",
    "Эй, {user}, ты как старая версия Windows, все время зависаешь.",
    "Извини, {user}, но в твоем мышлении полно вирусов.",
    "Ставлю деньги, что твои идеи не только бредовые, но и подлежат удалению.",
    "Эй, {user}, если бы ты был цветком, я бы тебя не поливал.",
    "{user}, может, пришло время заняться чем-то, что вызывает у тебя интерес?",
    "Ты как летающая тарелка, {user} — никто не верит, что ты существуешь.",
    "Эй, {user}, твоя жизнь как пазл, в котором не хватает половины деталей.",
    "Ты как старая книга — много страниц, но не о чем говорить.",
    "{user}, если бы твое лицо давали на картинках, их бы не печатали.",
    "Слушай, {user}, ты как `null` в программистском коде — не нужный. Зачем тебя вообще создавать?"
    "Эй, {user}, у тебя такая же скорость мышления, как у черепахи на диете.",
    "{user}, ты как сломанный калькулятор — просто не работаешь.",
    "Извини, {user}, но твоя логика — это как черное отверстие: ничего не выходит.",
    "{user}, если бы глупость была спортом, ты был бы чемпионом мира.",
    "Ты, {user}, как гусеница — мимо проходишь, но полезной не являешься.",
    "Эй, {user}, твои идеи такие же пустые, как твое резюме.",
    "{user}, даже Google не может найти для тебя подходящего объяснения.",
    "Слушай, {user}, ты как часовой механизм без пружинки — не крутится.",
    "Ты как загадка для идиота, {user} — никто не хочет решать.",
    "Эй, {user}, с тобой даже облака пройдут мимо, не оставив следа.",
    "{user}, твое жизненное кредо — лучше молчать, чем говорить глупости.",
    "Если бы твоя жизнь была книгой, она была бы заветной в библиотеке.",
    "Ты, {user}, как обновление программы — появляется внезапно и портит все.",
    "Извини, {user}, но даже блюда из Макдональдса кажутся умнее тебя.",
    "Эй, {user}, ты как сайт без содержания — просто пустое место.",
    "{user}, твоя карьера такая же бесперспективная, как работа в архиве.",
    "Слушай, {user}, ты как чайник без воды — не кипишь никогда.",
    "Ты как шутка без конца, {user} — никому не смешно.",
    "Эй, {user}, даже твой кот не хочет научиться делать то, что ты делаешь.",
    "{user}, ты как морская звезда — не знаешь, что делаешь.",
    "Слушай, {user}, твоя жизнь как фильм без звука — все выглядит странно.",
    "Ты, {user}, как айсберг — только вершина видна, остальное в тени.",
    "Эй, {user}, твой аргумент такой же слабый, как и твое кофе в офисе.",
    "{user}, даже холодильник не хочет держать тебя в своих ящиках.",
    "Извини, {user}, но твоя улыбка выглядит как белый фон — ничем не примечательно.",
    "Ты как лень, {user} — всегда со мной, но я от нее не в восторге.",
    "Эй, {user}, твои мечты о карьере такие же далекие, как планеты за пределами Солнечной системы.",
    "{user}, если бы негодяй имел лицо, он выглядел бы как ты.",
    "Ты как Wi-Fi в общественном месте, {user} — слабый и вызывающий раздражение.",
    "Эй, {user}, твоя жизнь как недоизученная тема — все спрашивают, но никто не знает.",
    "Слушай, {user}, ты как старая шутка — никому не смешно.",
    "Ты как цветок без земли, {user} — нет растительности.",
    "{user}, ты как уединенное озеро — тишина и много воды.",
    "Эй, {user}, даже эволюция не может помочь тебе осуществить прогресс.",
    "Ты как отмененный проект, {user} — все ждали, но он не состоялся.",
    "Извини, {user}, но даже за индексом у тебя нет наблюдений.",
    "Слушай, {user}, ты как дубликат в коде — никому не нужен.",
    "Эй, {user}, ты как старая кассета — по кругу одно и то же.",
    "{user}, твоя жизнь как игра без правил — никто не знает, что делать.",
    "Ты как запечатанный конверт, {user} — внутри ничего нет.",
    "Эй, {user}, твое присутствие как черная дыра — всё поглощает, но не дает ничего взамен.",
    "Ты, {user}, как путаница в файловой системе — неразбериха.",
    "Извини, {user}, но даже пчелы летают от твоего запаха.",
    "Ты как экран телефона без зарядки, {user} — не запускается.",
    "Эй, {user}, ты как змея без яда — никому не интересен.",
    "Слушай, {user}, с твоими способностями даже бутылка кетчупа может выиграть соревнования.",
    "Ты как скамейка в парке — все проходят мимо.",
    "{user}, ты как старый будильник — постоянно бесит, но не помогает.",
    "Эй, {user}, твой юмор напоминает устаревший софт — никаких улучшений.",
    "Ты как фотографии во время шторма, {user} — размыты и неясны.",
    "Извини, {user}, но даже компьютерные вирусы не хотят заражать твой разум.",
    "{user}, ты как зарядное устройство для Nokia — неприменим в современном мире.",
    "Эй, {user}, ты как недосказанная шутка — все ждут окончания, но его нет."
]


responses = [
    "Да, это так.",
    "Нет, это невозможно.",
    "Возможно, но маловероятно.",
    "Спросите позже, я занят.",
    "Лучше вам не знать.",
    "Сконцентрируйтесь и спросите снова.",
    "Не уверен, это сложный вопрос.",
    "Однозначно да!",
    "Однозначно нет!",
    "Может быть."
]

class Fun(commands.Cog):
    def __init__(self, bot):
        self.bot = bot

    @commands.command(name="hello", help="Приветствует пользователя.")
    async def hello(self, ctx):
        """Отправляет приветственное сообщение."""
        await ctx.message.delete()  # Удаляем сообщение с командой
        embed = create_embed(
            title="Привет, я Кентовка Лидер!",  # Более информативный заголовок
            description="Я предназначен для частного использования членами Кентовки SusMan-а.",
            color=discord.Color.green(),
            thumbnail_url="https://tools.corenexis.com/image/cnxm/M25/03/a1df7927f3.webp",  # Добавим картинку
            fields=[
                {"name": "Разработчик", "value": "SusMan", "inline": False},
                {"name": "Версия", "value": "1.0", "inline": True},
                {"name": "Префикс", "value": f"`{ctx.prefix}`", "inline": True}  # Добавили информацию о префиксе
            ],
            footer_text=f"Запрошено {ctx.author.name}",  # Добавляем информацию о пользователе
            footer_icon_url=ctx.author.avatar.url  # Добавляем аватар пользователя
        )
        await ctx.send(embed=embed)

    @commands.command(name="ping", help="Показывает задержку бота.")
    async def ping(self, ctx):
        """Показывает задержку бота."""
        await ctx.message.delete()  # Удаляем сообщение с командой
        embed = create_embed(
            title="Понг!",
            description=f"Задержка: {round(self.bot.latency * 1000)}мс",
            color=discord.Color.blue(),
            footer_text=f"Запрошено {ctx.author.name}",  # Добавляем информацию о пользователе
            footer_icon_url=ctx.author.avatar.url  # Добавляем аватар пользователя
        )
        await ctx.send(embed=embed)

    @commands.command(name="say", help="Повторяет текст, который вы введете.")
    async def say(self, ctx, *, text):
        """Повторяет введенный текст."""
        await ctx.message.delete()  # Удаляем сообщение с командой
        embed = create_embed(
            description=text,
            color=discord.Color.orange(),
            footer_text=f"Запрошено {ctx.author.name}",  # Добавляем информацию о пользователе
            footer_icon_url=ctx.author.avatar.url  # Добавляем аватар пользователя
        )
        await ctx.send(embed=embed)

    @commands.command(name="roast", help="Оскорбляет указанного пользователя.")
    async def roast(self, ctx, user: discord.Member = None):
        """Оскорбляет пользователя (или автора сообщения)."""
        await ctx.message.delete()  # Удаляем сообщение с командой
        if user is None:
            user = ctx.author
        roast_text = random.choice(roasts).format(user=user.mention)
        embed = create_embed(
            description=roast_text,
            color=discord.Color.dark_red(),
            footer_text=f"Запрошено {ctx.author.name}",  # Добавляем информацию о пользователе
            footer_icon_url=ctx.author.avatar.url  # Добавляем аватар пользователя
        )
        await ctx.send(embed=embed)

    @commands.command(name="ask", help="Отвечает на ваш вопрос случайным образом.")
    async def ask(self, ctx, *, question):
        """Отвечает на вопрос случайным образом."""
        await ctx.message.delete()  # Удаляем сообщение с командой
        answer = random.choice(responses)
        embed = create_embed(
            title=f"Вопрос: {question}",
            description=f"Ответ: {answer}",
            color=discord.Color.purple(),
            footer_text=f"Запрошено {ctx.author.name}",  # Добавляем информацию о пользователе
            footer_icon_url=ctx.author.avatar.url  # Добавляем аватар пользователя
        )
        await ctx.send(embed=embed)

    @commands.command(name="meme", help="Отправляет случайный мем. Можно указать ключевое слово для поиска.")
    async def meme(self, ctx, *, search_term: str = None):
        """Отправляет случайный мем из Imgur.com. Если указан search_term, ищет мемы по ключевому слову."""
        await ctx.message.delete()  # Удаляем сообщение с командой
        # Получаем API-ключ Imgur из переменной окружения
        IMGUR_CLIENT_ID = os.environ.get("IMGUR_CLIENT_ID")

        if not IMGUR_CLIENT_ID:
            await ctx.send("Необходимо настроить API-ключ Imgur (IMGUR_CLIENT_ID) в .env.")
            return

        headers = {"Authorization": f"Client-ID {IMGUR_CLIENT_ID}"}
        try:
            if search_term:
                # Если указан поисковый запрос
                url = f"https://api.imgur.com/3/gallery/search?q={search_term}"
            else:
                # Если нет поискового запроса, получаем случайные мемы из раздела 'hot'
                url = "https://api.imgur.com/3/gallery/hot?viral=true&mature=false&album_previews=true"

            response = requests.get(url, headers=headers)
            response.raise_for_status()  # Проверка на HTTP ошибки

            data = response.json()

            if not data["data"]:
                await ctx.send("Ничего не найдено по вашему запросу.")
                return

            # Выбираем случайный элемент из результатов
            images = [item for item in data["data"] if 'images' in item and item['images']]
            if not images:
                images = data["data"]

            meme = random.choice(images)

            if 'images' in meme:
                image = random.choice(meme['images'])
                image_url = image['link']
                meme_title = meme['title']
            else:
                image_url = meme['link']
                meme_title = meme['title']
            embed = create_embed(
                title=meme_title,
                color=discord.Color.blurple(),
                image_url=image_url,
                footer_text=f"Запрошено {ctx.author.name}",  # Добавляем информацию о пользователе
                footer_icon_url=ctx.author.avatar.url  # Добавляем аватар пользователя
            )
            await ctx.send(embed=embed)

        except requests.exceptions.RequestException as e:
            print(f"Ошибка при запросе к Imgur API: {e}")
            await ctx.send("Не удалось получить мем (ошибка API).")
        except (KeyError, IndexError) as e:
            print(f"Ошибка при обработке данных: {e}")
            await ctx.send("Не удалось получить мем (ошибка данных).")
        except Exception as e:
            print(f"Неизвестная ошибка: {e}")
            await ctx.send("Произошла неизвестная ошибка.")

async def setup(bot):
    await bot.add_cog(Fun(bot))